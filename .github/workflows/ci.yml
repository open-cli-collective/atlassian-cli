name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      cfl: ${{ steps.filter.outputs.cfl }}
      jtk: ${{ steps.filter.outputs.jtk }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cfl:
              - 'tools/cfl/**'
            jtk:
              - 'tools/jtk/**'
            shared:
              - 'shared/**'

  build-test-cfl:
    needs: detect-changes
    if: needs.detect-changes.outputs.cfl == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Build cfl
        run: go build -v ./tools/cfl/...
      - name: Test cfl
        run: go test -v -race -coverprofile=coverage-cfl.out ./tools/cfl/...

  build-test-jtk:
    needs: detect-changes
    if: needs.detect-changes.outputs.jtk == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Build jtk
        run: go build -v ./tools/jtk/...
      - name: Test jtk
        run: go test -v -race -coverprofile=coverage-jtk.out ./tools/jtk/...

  lint-cfl:
    needs: detect-changes
    if: needs.detect-changes.outputs.cfl == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - uses: golangci/golangci-lint-action@v6
        with:
          working-directory: tools/cfl
          version: v2.0.2

  lint-jtk:
    needs: detect-changes
    if: needs.detect-changes.outputs.jtk == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - uses: golangci/golangci-lint-action@v6
        with:
          working-directory: tools/jtk
          version: v2.0.2
