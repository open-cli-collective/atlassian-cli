name: Winget Publish cfl

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.9.150)'
        required: true
        type: string

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ inputs.version }}"
          $tag = "cfl-v$version"
          gh release download $tag --pattern "checksums.txt" --dir artifacts

      - name: Extract checksums
        run: |
          $version = "${{ inputs.version }}"
          $checksums = Get-Content artifacts/checksums.txt
          $amd64 = ($checksums | Select-String "cfl_${version}_windows_amd64.zip").ToString().Split(" ")[0]
          $arm64 = ($checksums | Select-String "cfl_${version}_windows_arm64.zip").ToString().Split(" ")[0]
          echo "CHECKSUM_AMD64=$amd64" >> $env:GITHUB_ENV
          echo "CHECKSUM_ARM64=$arm64" >> $env:GITHUB_ENV

      - name: Install wingetcreate
        run: |
          iwr https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Update and submit manifest
        run: |
          $version = "${{ inputs.version }}"
          $baseUrl = "https://github.com/open-cli-collective/atlassian-cli/releases/download/cfl-v$version"

          ./wingetcreate.exe update OpenCLICollective.cfl `
            --version $version `
            --urls "$baseUrl/cfl_${version}_windows_amd64.zip|x64" "$baseUrl/cfl_${version}_windows_arm64.zip|arm64" `
            --submit `
            --token ${{ secrets.WINGET_GITHUB_TOKEN }}
